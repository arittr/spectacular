---
runId: dedf14
feature: worktree-isolation
created: 2025-10-23
status: ready
---

# Feature: Worktree Isolation - Implementation Plan

> **Generated by:** Task Decomposition skill
> **From spec:** specs/dedf14-worktree-isolation/spec.md
> **Created:** 2025-10-23

## Execution Summary

- **Total Tasks**: 4
- **Total Phases**: 3
- **Sequential Time**: 15h
- **Parallel Time**: 12h
- **Time Savings**: 3h (20%)

**Parallel Opportunities:**

- Phase 1: 2 tasks (3h saved)

---

## Phase 1: Foundation Skills (Parallel)

**Strategy**: parallel
**Reason**: Task 1 and Task 2 are independent - different files, different subsystems (worktree management vs subagent orchestration)

### Task 1: Worktree Management Foundation

**Files**:

- skills/managing-worktrees/SKILL.md
- commands/cleanup.md

**Complexity**: M (4h)

**Dependencies**: None

**Description**:

Create the complete worktree management subsystem including the skill for worktree lifecycle operations and the cleanup command. This is a thematically coherent unit - both the skill and command are about worktree lifecycle management, and the command directly uses patterns from the skill.

**Implementation Steps**:

1. Create `skills/managing-worktrees/SKILL.md` following superpowers skill format:
   - Add YAML frontmatter with name and description
   - Write "When to Use" section (trigger conditions)
   - Add announcement requirement
   - Document Pattern 1: Create main worktree with resume validation
     - Command: `git worktree add .worktrees/{runId}-main`
     - Validation: Check for dirty state, detached HEAD
     - Resume logic: Reuse if clean, error if dirty
   - Document Pattern 2: Create parallel task worktrees
     - Command: `git worktree add .worktrees/{runId}-task-{phase}-{task}`
     - Per-task isolation strategy
   - Document Pattern 3: Cleanup parallel worktrees (with mandatory TodoWrite checklist)
     - Command: `git worktree remove .worktrees/{runId}-task-{phase}-{task}`
     - Preserve branches (only remove working directories)
     - TodoWrite requirement for multi-worktree cleanup
   - Document Pattern 4: Manual cleanup command support
     - Remove all worktrees for a runId
     - Validation before removal
   - Add error handling section (worktree conflicts, dirty state, invalid paths)
   - Include rationalization table for predictable shortcuts

2. Create `commands/cleanup.md` following command format:
   - Add YAML frontmatter with description: "Remove all worktrees for a spectacular run"
   - Document command syntax: `/spectacular:cleanup {runId}`
   - Write workflow steps:
     - Step 1: Validate runId format (6-char hash)
     - Step 2: Announce usage of `managing-worktrees` skill
     - Step 3: List all worktrees matching `.worktrees/{runId}-*`
     - Step 4: Create TodoWrite checklist for each worktree to remove
     - Step 5: Delegate to skill Pattern 4 for cleanup
     - Step 6: Report completion with list of removed worktrees
   - Add error handling (no worktrees found, removal failures, dirty state warnings)
   - Document that branches are preserved (only working directories removed)

3. Add `.worktrees/` to `.gitignore` if not already present

4. Test both skill and command work together:
   - Create test worktree: `git worktree add .worktrees/test-main`
   - Verify cleanup command can remove it
   - Verify error messages for dirty state

**Acceptance Criteria**:

- [ ] Skill follows superpowers format (frontmatter, When to Use, announcement, patterns, error handling)
- [ ] All 4 patterns documented with concrete git commands
- [ ] Pattern 3 includes mandatory TodoWrite checklist requirement
- [ ] Cleanup command properly delegates to skill
- [ ] Command creates TodoWrite todos for multi-worktree cleanup
- [ ] Error handling covers worktree conflicts, dirty state, invalid runIds
- [ ] `.worktrees/` is gitignored
- [ ] Manual testing shows skill and command work together correctly

**Mandatory Patterns**:

> **Constitution**: This is a documentation-only project - no traditional tests/builds. Validation is via manual testing and adherence to superpowers skill format.

See CLAUDE.md for skill structure requirements and command format.

**TDD**: Not applicable (documentation-only project)

**Quality Gates**:

```bash
# Manual validation
cat skills/managing-worktrees/SKILL.md | grep -E "^---$|^name:|^description:"
cat commands/cleanup.md | grep -E "^---$|^description:"

# Test in sample repo
cd /tmp/test-repo
git worktree add .worktrees/dedf14-main
ls .worktrees/
# Run cleanup command via Claude Code
# Verify worktree removed
```

---

### Task 2: Subagent Orchestration Skill

**Files**:

- skills/orchestrating-isolated-subagents/SKILL.md

**Complexity**: M (3h)

**Dependencies**: None

**Description**:

Create the skill that defines directory isolation patterns for orchestrator and subagent coordination. This ensures the orchestrator stays in the main repo while subagents work in isolated worktrees.

**Implementation Steps**:

1. Create `skills/orchestrating-isolated-subagents/SKILL.md` following superpowers format:
   - Add YAML frontmatter with name and description
   - Write "When to Use" section:
     - Trigger: When dispatching subagents for task execution in worktrees
     - Context: Orchestrator must stay in main repo, subagents work in isolation
   - Add announcement requirement
   - Document Pattern 1: Orchestrator stays in main repo
     - Never use `cd` commands
     - Always pass absolute paths to subagents
     - Use `WORKTREE_PATH` parameter in subagent prompts
   - Document Pattern 2: Subagent receives absolute paths and cd into worktree
     - First step: Verify WORKTREE_PATH parameter received
     - Second step: `cd $WORKTREE_PATH`
     - Validation: Check pwd matches expected path
     - All file operations relative to worktree
   - Document Pattern 3: Path verification and error handling
     - Verify worktree exists before dispatch
     - Verify subagent successfully changed directory
     - Error recovery: Orchestrator detects failed cd, aborts task
   - Add error handling section:
     - Missing WORKTREE_PATH parameter
     - Worktree doesn't exist
     - Subagent cd fails
     - Path confusion (working in wrong directory)
   - Include rationalization table:
     - "Orchestrator can cd for one quick command" → NO, always delegate
     - "Subagent doesn't need cd, paths are relative" → NO, must cd to establish context

2. Add concrete examples for each pattern:
   - Example orchestrator prompt with WORKTREE_PATH parameter
   - Example subagent first steps (verify param, cd, verify pwd)
   - Example error detection and recovery

3. Document integration with `managing-worktrees` skill:
   - Orchestrator creates worktrees using managing-worktrees patterns
   - Then dispatches subagents with orchestrating-isolated-subagents patterns
   - Clear separation of concerns

4. Add TodoWrite requirements:
   - Orchestrator must create TodoWrite checklist for subagent dispatch
   - Track each subagent's directory isolation status

**Acceptance Criteria**:

- [ ] Skill follows superpowers format completely
- [ ] Pattern 1 clearly states orchestrator NEVER uses cd
- [ ] Pattern 2 provides concrete subagent first-steps workflow
- [ ] Pattern 3 covers all error scenarios with recovery steps
- [ ] Examples show exact prompt structure with WORKTREE_PATH parameter
- [ ] Rationalization table prevents common shortcuts
- [ ] Integration with managing-worktrees skill is documented
- [ ] TodoWrite requirements specified for orchestrator

**Mandatory Patterns**:

> **Constitution**: Documentation-only project - validation via manual testing and format adherence.

See CLAUDE.md for skill structure requirements.

**TDD**: Not applicable (documentation-only project)

**Quality Gates**:

```bash
# Manual validation
cat skills/orchestrating-isolated-subagents/SKILL.md | grep -E "^---$|^name:|^description:"

# Verify structure
grep -A 5 "## When to Use" skills/orchestrating-isolated-subagents/SKILL.md
grep -A 5 "## Pattern 1" skills/orchestrating-isolated-subagents/SKILL.md
grep -A 5 "## Pattern 2" skills/orchestrating-isolated-subagents/SKILL.md
grep -A 5 "## Pattern 3" skills/orchestrating-isolated-subagents/SKILL.md
```

---

## Phase 2: Git-Spice Enhancement (Sequential)

**Strategy**: sequential
**Reason**: Task 3 depends on Task 1 - must reference worktree management patterns for concurrent safety

### Task 3: Git-Spice Concurrent Safety Enhancement

**Files**:

- skills/using-git-spice/SKILL.md

**Complexity**: S (2h)

**Dependencies**: Task 1 (references worktree management patterns)

**Description**:

Enhance the existing `using-git-spice` skill with a new section on concurrent run safety. This documents which git-spice operations are safe during parallel spectacular runs and which require coordination.

**Implementation Steps**:

1. Read existing `skills/using-git-spice/SKILL.md` to understand current structure

2. Add new section after existing patterns: "## Concurrent Run Safety"

3. Document safe operations during parallel runs:
   - `gs branch create` - Safe (each worktree creates independent branches)
   - `gs upstack onto` - Safe (operates on current branch's stack)
   - `gs stack submit` - Safe (operates on current branch's stack)
   - `gs branch checkout` - Safe within worktree (doesn't affect other worktrees)

4. Document unsafe operations requiring coordination:
   - `gs repo restack` - Unsafe (affects entire repository)
   - `gs repo sync` - Unsafe (pulls changes across all branches)
   - Recommendation: Only run these in main repo when no spectacular runs active

5. Add worktree-specific patterns:
   - Reference `managing-worktrees` skill for worktree creation
   - Document that each worktree has independent HEAD
   - Explain shared `.git` database (all worktrees see same branches)
   - Note that branch creation in worktree requires `git switch --detach` for accessibility

6. Add error handling for concurrent conflicts:
   - Branch already exists (another run created it)
   - Restack in progress (another operation modifying stacks)
   - Recovery: Wait for other operation to complete

7. Add to rationalization table:
   - "Repo restack is fine during parallel runs" → NO, wait for runs to complete
   - "Don't need to detach after branch create" → NO, required for parent repo access

**Acceptance Criteria**:

- [ ] New section "Concurrent Run Safety" added after existing patterns
- [ ] Safe operations documented with clear explanation of why they're safe
- [ ] Unsafe operations documented with coordination requirements
- [ ] Worktree-specific patterns reference `managing-worktrees` skill
- [ ] `git switch --detach` requirement explained for parallel tasks
- [ ] Error handling covers concurrent conflicts
- [ ] Rationalization table updated with concurrent safety shortcuts
- [ ] Section integrates smoothly with existing skill content

**Mandatory Patterns**:

> **Constitution**: Documentation-only project - validation via format adherence.

See CLAUDE.md for skill structure requirements.

**TDD**: Not applicable (documentation-only project)

**Quality Gates**:

```bash
# Verify section added
grep -A 10 "## Concurrent Run Safety" skills/using-git-spice/SKILL.md

# Verify safe operations documented
grep -E "gs branch create|gs upstack onto|gs stack submit" skills/using-git-spice/SKILL.md

# Verify unsafe operations documented
grep -E "gs repo restack|gs repo sync" skills/using-git-spice/SKILL.md

# Verify references managing-worktrees skill
grep "managing-worktrees" skills/using-git-spice/SKILL.md
```

---

## Phase 3: Execute Command Integration (Sequential)

**Strategy**: sequential
**Reason**: Task 4 depends on Tasks 1 and 2 - must use patterns from both skills

### Task 4: Execute Command Worktree Integration

**Files**:

- commands/execute.md

**Complexity**: L (6h)

**Description**:

Update the entire `/spectacular:execute` workflow to use worktree isolation. This is a major rewrite that integrates both the `managing-worktrees` and `orchestrating-isolated-subagents` skills throughout the execution flow.

**Implementation Steps**:

1. Read existing `commands/execute.md` to understand current workflow structure

2. Update Step 0 (Setup) to add Step 0c: Create Main Worktree
   - After Step 0b (extract runId), add new step
   - Announce usage of `managing-worktrees` skill
   - Delegate to setup subagent with task: "Create main worktree for runId {runId}"
   - Setup subagent prompt must include:
     - Use `managing-worktrees` skill Pattern 1
     - Create `.worktrees/{runId}-main` from current branch
     - Validate or resume if worktree already exists
     - Report worktree path back to orchestrator
   - Add error handling: If worktree creation fails, abort execution

3. Update sequential task execution (current Step 2):
   - Add to setup subagent prompt: After creating main worktree, `cd .worktrees/{runId}-main`
   - For each sequential task dispatch:
     - Pass `WORKTREE_PATH=.worktrees/{runId}-main` parameter
     - Reference `orchestrating-isolated-subagents` skill Pattern 2
     - Subagent first step: Verify in correct worktree via `pwd`
   - All sequential tasks now execute in isolated main worktree

4. Update parallel phase execution (current Step 3):
   - Before dispatching parallel tasks, create task worktrees
   - For each parallel task:
     - Create worktree: `.worktrees/{runId}-task-{phase}-{task}`
     - Use `managing-worktrees` skill Pattern 2
     - Dispatch implementation subagent with `WORKTREE_PATH` parameter
     - Use `orchestrating-isolated-subagents` skill Pattern 2
   - After parallel tasks complete, cleanup phase:
     - Use `managing-worktrees` skill Pattern 3
     - Create TodoWrite checklist for each worktree removal
     - Remove parallel worktrees (preserve branches)
     - Verify cleanup completed before continuing

5. Update cleanup subagent responsibilities (current Step 4):
   - Cleanup subagent now runs in main repo (NOT in worktree)
   - Reference `orchestrating-isolated-subagents` skill Pattern 1
   - Task: Create linear stack from parallel branches
   - Use `gs upstack onto` for each parallel task branch
   - Verify stack created correctly

6. Add skill references throughout:
   - Every worktree operation references `managing-worktrees`
   - Every subagent dispatch references `orchestrating-isolated-subagents`
   - Sequential task flow references both skills
   - Parallel task flow references both skills

7. Update orchestrator instructions:
   - Add explicit reminder: Orchestrator stays in main repo
   - Never use `cd` commands in orchestrator
   - Always verify subagent directory before proceeding
   - Use `orchestrating-isolated-subagents` skill Pattern 1

8. Update error handling throughout:
   - Worktree creation failures
   - Subagent cd failures
   - Cleanup failures (dirty worktrees)
   - Add recovery steps for each failure mode

9. Add main worktree preservation note:
   - After execution completes, main worktree left in place
   - User can manually clean with `/spectacular:cleanup {runId}`
   - Benefits: Resume capability, inspection of final state

**Acceptance Criteria**:

- [ ] Step 0c added for main worktree creation with setup subagent delegation
- [ ] Sequential tasks execute in `.worktrees/{runId}-main` with WORKTREE_PATH parameter
- [ ] Parallel tasks each get isolated worktrees with cleanup after phase
- [ ] All worktree operations reference `managing-worktrees` skill
- [ ] All subagent dispatches reference `orchestrating-isolated-subagents` skill
- [ ] Orchestrator instructions explicitly prohibit `cd` commands
- [ ] TodoWrite checklist created for parallel worktree cleanup
- [ ] Error handling covers all worktree failure modes
- [ ] Main worktree preserved after execution (cleanup via `/spectacular:cleanup`)
- [ ] Cleanup subagent runs in main repo (not worktree) for stacking

**Mandatory Patterns**:

> **Constitution**: Documentation-only project - validation via manual testing in sample project.

See CLAUDE.md for command structure requirements.

**TDD**: Not applicable (documentation-only project)

**Quality Gates**:

```bash
# Verify Step 0c added
grep -A 10 "Step 0c" commands/execute.md

# Verify skill references throughout
grep "managing-worktrees" commands/execute.md | wc -l  # Should be multiple
grep "orchestrating-isolated-subagents" commands/execute.md | wc -l  # Should be multiple

# Verify WORKTREE_PATH parameter usage
grep "WORKTREE_PATH" commands/execute.md

# Verify orchestrator never cd
grep -i "orchestrator.*cd" commands/execute.md  # Should warn AGAINST cd

# Manual testing in sample project
# 1. Run /spectacular:execute with this updated command
# 2. Verify main repo pwd never changes
# 3. Verify sequential tasks run in main worktree
# 4. Verify parallel tasks run in separate worktrees
# 5. Verify cleanup removes parallel worktrees
# 6. Verify main worktree preserved after execution
```

---

## Post-Execution Validation

After completing all tasks:

1. **Constitution compliance check**:
   - [ ] Skills follow superpowers format (frontmatter, When to Use, patterns, error handling, rationalization table)
   - [ ] Commands delegate to skills (no direct implementation)
   - [ ] TodoWrite usage documented for multi-step workflows
   - [ ] Git-spice patterns followed in concurrent safety section

2. **Feature completeness check**:
   - [ ] Main repo never changes directory during execution (orchestrator pattern)
   - [ ] Sequential tasks execute in `.worktrees/{runId}-main`
   - [ ] Parallel tasks execute in separate worktrees (`.worktrees/{runId}-task-{phase}-{task}`)
   - [ ] Cleanup command removes worktrees without affecting branches
   - [ ] Resume capability via main worktree validation

3. **Integration testing** (manual):
   - [ ] Create sample project with test spec
   - [ ] Run `/spectacular:execute` and verify no main repo directory changes
   - [ ] Verify sequential tasks work in main worktree
   - [ ] Verify parallel tasks work in isolated worktrees
   - [ ] Verify cleanup removes worktrees cleanly
   - [ ] Run `/spectacular:cleanup {runId}` and verify manual cleanup works
   - [ ] Test concurrent runs with different runIds (no interference)

4. **Documentation check**:
   - [ ] All skills have complete error handling sections
   - [ ] All patterns have concrete examples
   - [ ] Command workflows reference skills explicitly
   - [ ] Rationalization tables prevent common shortcuts

---

## References

- Spec: specs/dedf14-worktree-isolation/spec.md
- Superpowers skill format: https://github.com/obra/superpowers
- Git worktree docs: https://git-scm.com/docs/git-worktree
- Git-spice docs: https://github.com/abhinav/git-spice
- Project structure: CLAUDE.md
